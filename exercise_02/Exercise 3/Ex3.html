<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>Stack generator</title>
</head>

<style>
</style>

<body>
    <svg id="chart" width="700" height="800">
        <g></g>
    </svg>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
        function getCol(origin, col) {
            return origin.map(row => row[col]);
        }

        function getUniqueValues(array, column) {
            return getCol(array, column).filter((value, index, self) =>
                self.indexOf(value) === index
            );
        }

        d3.csv('Data/Covid19Worldwide.csv').then(function (dataArray) {
            dataArray.forEach(tuple => {
                tuple.niceDate = tuple.dateRep.split("/").reverse().join("-")
            });
            days = getUniqueValues(dataArray, "niceDate");
            days.sort((t1, t2) => {
                return t1 >= t2;
            });
            continents = getUniqueValues(dataArray, "continentExp");

            function getContinentDataArray(column) {
                continentDataArray = [];

                //Init data structure
                days.forEach(day => {
                    newObject = new Object();
                    newObject["day"] = day;
                    continents.forEach(continent => {
                        newObject[continent] = 0;
                    });
                    continentDataArray.push(newObject);
                });

                //Fill with rum
                continentDataArray.forEach(tuple => {
                    const filtered = dataArray.filter(value => {
                        return value.niceDate == tuple.day;
                    });
                    continents.forEach(continent => {
                        const sumForContinent = filtered.filter(value => {
                            return value.continentExp == continent;
                        }).map(tuple => parseInt(tuple[column])).reduce((t1, t2) => t1 + t2, 0);
                        tuple[continent] += sumForContinent;
                    });
                });

                return continentDataArray;
            }

            var stack = d3.stack()
                .keys(continents);

            var showCases = true;
            casesArray = stack(getContinentDataArray("cases"));
            deathsArray = stack(getContinentDataArray("deaths"));
            var yScale = d3.scaleLinear().domain([-10000, 10000]).range([800, 0]);

            var areaGenerator = d3.area()
                .x(function (d, i) {
                    return i * 2;
                })
                .y0(function (d) {
                    return yScale(d[0]);
                })
                .y1(function (d) {
                    return yScale(d[1]);
                });

            var colors = d3.scaleOrdinal().range(d3.schemeCategory10);

            stackedChart =
                d3.select('g')
                    .selectAll('path')
                    .data(casesArray)
                    .enter()


            stackedChart
                .append('path')
                .style('fill', function (d, i) {
                    return colors(i);
                })
                .attr('d', areaGenerator)

            function getDataWithSwitch() {
                showCases = !showCases;
                if (showCases) {
                    return casesArray;
                } else {
                    return deathsArray;
                }
            }
            function transit() {
                data = getDataWithSwitch()
                stackedChart
                .selectAll('path')
                .data(data)
                .transition()
                .duration(3000)
                .attr('d', areaGenerator);
            }

            d3.select("#chart").on("click", transit);
        });


    </script>
</body>

</html>