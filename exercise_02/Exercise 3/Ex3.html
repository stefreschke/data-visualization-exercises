<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>COVID cases and deaths</title>
</head>

<style>
    * {
        font-family: sans-serif;
    }
</style>

<body>
    <h1>COVID cases and deaths</h1>
    <h2>Cummulated numbers for specified regions per day</h2>
    <p>Click on the graph, to switch between cases and deaths</p>
    <svg id="chart" width="1000" height="600">
        <g></g>
    </svg>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
        function getCol(origin, col) {
            return origin.map(row => row[col]);
        }

        function getUniqueValues(array, column) {
            return getCol(array, column).filter((value, index, self) =>
                self.indexOf(value) === index
            );
        }

        var getSVGAttribute = (s) => {
            const svg = document.getElementById("chart")
            return svg.attributes[s].value
        }

        d3.csv('Data/Covid19Worldwide.csv').then(function (dataArray) {

            //Preprocessing
            console.log("Starting preprocessing");

            dataArray.forEach(tuple => {
                tuple.niceDate = tuple.dateRep.split("/").reverse().join("-");
                tuple.cases = Math.max(tuple.cases, 0);
                tuple.deaths = Math.max(tuple.deaths, 0);
            });
            days = getUniqueValues(dataArray, "niceDate");
            days.sort((t1, t2) => {
                return t1 >= t2;
            });
            continents = getUniqueValues(dataArray, "continentExp");

            //Cummulate per Continent
            function getContinentDataArray(column) {
                continentDataArray = [];

                //Init data structure
                days.forEach(day => {
                    newObject = new Object();
                    newObject["day"] = day;
                    newObject["total"] = 0;
                    continents.forEach(continent => {
                        newObject[continent] = 0;
                    });
                    continentDataArray.push(newObject);
                });

                //Fill with rum
                continentDataArray.forEach(tuple => {
                    const filtered = dataArray.filter(value => {
                        return value.niceDate == tuple.day;
                    });
                    continents.forEach(continent => {
                        const sumForContinent = filtered.filter(value => {
                            return value.continentExp == continent;
                        }).map(tuple => parseInt(tuple[column])).reduce((t1, t2) => t1 + t2, 0);
                        tuple[continent] += sumForContinent;
                        tuple["total"] += sumForContinent;
                    });
                });
                return continentDataArray;
            }

            var stack = d3.stack()
                .keys(continents);
            casesArray = getContinentDataArray("cases");
            deathsArray = getContinentDataArray("deaths");
            casesArrayStacked = stack(casesArray);
            deathsArrayStacked = stack(deathsArray);

            const chart = d3.select("#chart")
            const chartWidth = getSVGAttribute("width");
            const chartHeight = getSVGAttribute("height");
            const textHeightXAxis = 50;
            const textWidthYAxis = 70;
            const pixelPerDay = ((chartWidth - textWidthYAxis) / days.length);

            //axis
            console.log("Defining axis");
            const xAxisDom = chart.append("g")
                .attr("id", "xAxis")
                .attr("transform", "translate(" + textWidthYAxis + "," + (chartHeight - textHeightXAxis) + ")");

            const yAxisDom = chart.append("g")
                .attr("id", "yAxis")
                .attr("transform", "translate(" + textWidthYAxis + ", 0)");

            maxCasesPerDay = Math.max.apply(null, getCol(casesArray, "total"));
            maxDeathsPerDay = Math.max.apply(null, getCol(deathsArray, "total"));
            console.log(casesArray)

            yScaleCases = d3.scaleLinear().domain([0, maxCasesPerDay]).range([chartHeight-textHeightXAxis, 0]);
            yScaleDeaths = d3.scaleLinear().domain([0, maxDeathsPerDay]).range([chartHeight-textHeightXAxis, 0]);
            xScale = d3.scaleTime().domain([new Date(days[0]), new Date(days[days.length - 1])]).range([0, days.length * pixelPerDay])

            yAxisDom.call(d3.axisLeft().scale(yScaleCases));
            xAxisDom.call(d3.axisBottom().scale(xScale))

            //Draw chart
            console.log("Drawing chart")

            var showCases = true; //Switch

            function getAreaGenerator(scaleToApply) {
                return d3.area()
                .x(function (d, i) {
                    return i * pixelPerDay + textWidthYAxis;
                })
                .y0(function (d) {
                    return scaleToApply(d[0])
                })
                .y1(function (d) {
                    return scaleToApply(d[1]);
                });
            }

            var colors = d3.scaleOrdinal().range(d3.schemeCategory10);

            stackedChart =
                d3.select('g')
                    .selectAll('path')
                    .data(casesArrayStacked)
                    .enter();


            stackedChart
                .append('path')
                .style('fill', function (d, i) {
                    return colors(i);
                })
                .attr('d', getAreaGenerator(yScaleCases));            

            function getDataWithSwitch() {
                showCases = !showCases;
                if (showCases) {
                    return casesArrayStacked;
                } else {
                    return deathsArrayStacked;
                }
            }
            function transit() {
                data = getDataWithSwitch()
                if (showCases) {
                    scaleToApply = yScaleCases;
                    yAxisDom.call(d3.axisLeft().scale(yScaleCases));
                } else {
                    scaleToApply = yScaleDeaths;
                    yAxisDom.call(d3.axisLeft().scale(yScaleDeaths));
                }
                stackedChart
                .selectAll('path')
                .data(data)
                .transition()
                .duration(3000)
                .attr('d', getAreaGenerator(scaleToApply));
            }

            d3.select("#chart").on("click", transit);
        });


    </script>
</body>

</html>