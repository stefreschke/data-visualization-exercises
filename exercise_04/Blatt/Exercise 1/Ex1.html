<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
        svg {
            font: 10px sans-serif;
        }

        * {
            font-family: 'sans serif';
        }

        .label {
            font-size: 12pt;
        }

        #legend {
            font-size: 11pt;
        }
    </style>
    <title>Course Development</title>
</head>

<body>
    <h1>Spaß, Spaß, Spaß</h1>
    <h4>Yuhuuuuu.</h4>
    <svg id="chart" width="1000" height="600" />
    <script src="//d3js.org/d3.v5.min.js"></script>
    <script>

        function getCol(origin, col) {
            return origin.map(row => row[col]);
        }

        var getSVGAttribute = (s) => {
            const svg = document.getElementById("chart")
            return svg.attributes[s].value
        }

        const height = getSVGAttribute("height")
        const width = getSVGAttribute("width")

        d3.csv('Data/MigrationFlow.csv').then((data) => {

            var nested = d3.nest()
                .key(d => d['region_orig'])
                .key(d => d['region_dest'])
                .entries(data)

            var nodes = []
            var links = []

            nested.forEach(node => {
                nodeObj = {}
                nodeObj['id'] = node.key
                nodes.push(nodeObj)
                node.values.forEach(value => {
                    linkObj = {}
                    linkObj['source'] = node.key
                    linkObj['target'] = value.key
                    linkObj['weight'] = value.values[0]['regionflow_2005']
                    links.push(linkObj)
                })
            })

            var label = {
                'nodes': [],
                'links': []
            };
            
            nodes.forEach(function(d, i) {
                label.nodes.push({node: d});
                label.nodes.push({node: d});
                label.links.push({
                    source: i * 2,
                    target: i * 2 + 1
                });
            });

            console.log(nodes)
            console.log(links)
            console.log(label)

            const chart = d3.select("#chart")

            var labelLayout = d3.forceSimulation(label.nodes)
                .force("charge", d3.forceManyBody().strength(-50))
                .force("link", d3.forceLink(label.links).distance(0).strength(2));

            var graphLayout = d3.forceSimulation(nodes)
                .force("charge", d3.forceManyBody().strength(-3000))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("x", d3.forceX(width / 2).strength(1))
                .force("y", d3.forceY(height / 2).strength(1))
                .force("link", d3.forceLink(links).id(function (d) { return d.id; }).distance(50).strength(1))
                .on("tick", ticked);

            var adjlist = [];

            links.forEach(function (d) {
                adjlist[d.source.index + "-" + d.target.index] = true;
                adjlist[d.target.index + "-" + d.source.index] = true;
            });

            function neigh(a, b) {
                return a == b || adjlist[a + "-" + b];
            }


            var container = chart.append("g");

            chart.call(
                d3.zoom()
                    .scaleExtent([.1, 4])
                    .on("zoom", function () { container.attr("transform", d3.event.transform); })
            );

            var linkDom = container.append("g").attr("class", "links")
                .selectAll("line")
                .data(links)
                .enter()
                .append("line")
                .attr("stroke", "#aaa")
                .attr("stroke-width", "1px");

            var nodeDom = container.append("g").attr("class", "nodes")
                .selectAll("g")
                .data(nodes)
                .enter()
                .append("circle")
                .attr("r", 5)
                .attr("fill", "steelblue")

            nodeDom.on("mouseover", focus).on("mouseout", unfocus);

            nodeDom.call(
                d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended)
            );

            /*var labelNode = container.append("g").attr("class", "labelNodes")
                .selectAll("text")
                .data(label.nodes)
                .enter()
                .append("text")
                .text(function (d, i) { return i % 2 == 0 ? "" : d.node['region_orig']; })
                .style("fill", "#555")
                .style("font-family", "Arial")
                .style("font-size", 12)
                .style("pointer-events", "none"); // to prevent mouseover/drag capture*/

            nodeDom.on("mouseover", focus).on("mouseout", unfocus);

            function ticked() {

                nodeDom.call(updateNode);
                linkDom.call(updateLink);

                labelLayout.alphaTarget(0.3).restart();
                /*labelNode.each(function (d, i) {
                    if (i % 2 == 0) {
                        d.x = d.node.x;
                        d.y = d.node.y;
                    } else {
                        var b = this.getBBox();

                        var diffX = d.x - d.node.x;
                        var diffY = d.y - d.node.y;

                        var dist = Math.sqrt(diffX * diffX + diffY * diffY);

                        var shiftX = b.width * (diffX - dist) / (dist * 2);
                        shiftX = Math.max(-b.width, Math.min(0, shiftX));
                        var shiftY = 16;
                        this.setAttribute("transform", "translate(" + shiftX + "," + shiftY + ")");
                    }
                }); */
                //labelNode.call(updateNode);

            }

            function fixna(x) {
                if (isFinite(x)) return x;
                return 0;
            }

            function focus(d) {
                var index = d3.select(d3.event.target).datum().index;
                nodeDom.style("opacity", function (o) {
                    return neigh(index, o.index) ? 1 : 0.1;
                });
                /*labelNode.attr("display", function (o) {
                    return neigh(index, o.nodeDom.index) ? "block" : "none";
                });*/
                linkDom.style("opacity", function (o) {
                    return o.source.index == index || o.target.index == index ? 1 : 0.1;
                });
            }

            function unfocus() {
                //labelNode.attr("display", "block");
                nodeDom.style("opacity", 1);
                linkDom.style("opacity", 1);
            }

            function updateLink(link) {
                link.attr("x1", function (d) { return fixna(d.source.x); })
                    .attr("y1", function (d) { return fixna(d.source.y); })
                    .attr("x2", function (d) { return fixna(d.target.x); })
                    .attr("y2", function (d) { return fixna(d.target.y); });
            }

            function updateNode(node) {
                node.attr("transform", function (d) {
                    return "translate(" + fixna(d.x) + "," + fixna(d.y) + ")";
                });
            }

            function dragstarted(d) {
                d3.event.sourceEvent.stopPropagation();
                if (!d3.event.active) graphLayout.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) graphLayout.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            alert("HALT!")

        })

    </script>
</body>

</html>