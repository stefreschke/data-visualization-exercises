<html>
    <header>
        <style>
            .line {
                opacity: 0.5;
            }

            svg {
                font: 10px sans-serif;
            }

            * {
                font-family: 'sans serif';
            }

            .label {
                font-size: 12pt;
            }
        </style>
    </header>

    <body>
        <script src="//d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/d3-delaunay@5"></script>
        <script>
            var width = 1200;
            var height = 700;
            var data;

            var minLat, maxLat, minLon, maxLon;
            var lonScale, latScale;

            function updateScales() {
                lonScale = d3.scaleLinear().domain([maxLon, minLon]).range([width, 0]);
                latScale = d3.scaleLinear().domain([maxLat, minLat]).range([0, height]);
            }

            var transform = (list) => {
                let result = [];
                result.push(lonScale(list[1]));
                result.push(latScale(list[0]));
                return result;
            };

            function fetchMinMaxLatLonFromData(data) {
                let lats = data.map((e) => +e.lat);
                let lons = data.map((e) => +e.lon);
                console.log(lats);
                console.log(lons);
                minLat = d3.min(lats);
                minLon = d3.min(lons);
                maxLat = d3.max(lats);
                maxLon = d3.max(lons);
                console.log('minLat ' + minLat);
                console.log('minLon ' + minLon);
                console.log('maxLat ' + maxLat);
                console.log('maxLon ' + maxLon);
                updateScales();
            }

            var color = d3.scaleOrdinal().range(d3.schemeTableau10);

            d3.csv('Data/postoffices_usa.csv').then(function (csvData) {
                let mainList = [];
                fetchMinMaxLatLonFromData(csvData);
                csvData.forEach((row) => {
                    let lat = +row.lat;
                    let lon = +row.lon;
                    mainList.push(transform([lat, lon]));
                });
                data = mainList;

                console.log('contains ' + data.length + ' elements');

                var delaunay = d3.Delaunay.from(data);
                var voronoi = delaunay.voronoi([0, 0, width, height]);
                var renderedVoronoi = voronoi.render();

                delaunay.findAll = function (x, y, radius) {
                    const points = delaunay.points,
                        results = [],
                        seen = [],
                        queue = [delaunay.find(x, y)];

                    while (queue.length) {
                        const q = queue.pop();
                        if (seen[q]) continue;
                        seen[q] = true;
                        if (Math.hypot(x - points[2 * q], y - points[2 * q + 1]) < radius) {
                            results.push(q);
                            for (const p of delaunay.neighbors(q)) queue.push(p);
                        }
                    }

                    return results;
                };

                var svg = d3
                    .select('body')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);

                var circleSpace = svg.append('g').attr('id', 'circle-space');

                

                svg.append('g')
                    .selectAll('path')
                    .data(data)
                    .enter()
                    .append('path')
                    .attr('d', (d, i) => voronoi.renderCell(i))
                    .attr('fill', (d, i) => color(i))
                    .attr('style', 'opacity: .2')
                    .attr('stroke', 'black')
                    .attr('stroke-width', '.5');

                    var circles = circleSpace
                    .selectAll('circle')
                    .data(data)
                    .join('circle')
                    .attr('fill', 'green')
                    .attr('cx', (d) => d[0])
                    .attr('cy', (d) => d[1])
                    .attr('r', 1);

                //var results = delaunay.findAll(width / 2, height / 2, 25);
            });
        </script>
    </body>
</html>
