<html>
    <header>
        <style>
            .line {
                opacity: 0.5;
            }

            svg {
                font: 10px sans-serif;
            }

            * {
                font-family: 'sans serif';
            }

            .label {
                font-size: 12pt;
            }

            /* Slider code taken from https://www.w3schools.com/howto/howto_js_rangeslider.asp*/
            .slidecontainer {
                width: 1100; /* Width of the outside container */
            }

            .slider {
                -webkit-appearance: none; /* Override default CSS styles */
                appearance: none;
                width: 100%; /* Full-width */
                height: 25px; /* Specified height */
                background: #d3d3d3; /* Grey background */
                outline: none; /* Remove outline */
                opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
                -webkit-transition: 0.2s; /* 0.2 seconds transition on hover */
                transition: opacity 0.2s;
            }

            .slider:hover {
                opacity: 1; /* Fully shown on mouse-over */
            }

            .slider::-webkit-slider-thumb {
                -webkit-appearance: none; /* Override default look */
                appearance: none;
                width: 25px; /* Set a specific slider handle width */
                height: 25px; /* Slider handle height */
                background: grey; /* Green background */
                cursor: pointer; /* Cursor on hover */
            }

            .slider::-moz-range-thumb {
                width: 25px; /* Set a specific slider handle width */
                height: 25px; /* Slider handle height */
                background: grey; /* Green background */
                cursor: pointer; /* Cursor on hover */
            }
        </style>
    </header>

    <body>
        <script src="//d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/d3-delaunay@5"></script>
        <h1>asdf</h1>
        <h4>asdf</h4>
        <div class="slidecontainer">
            <input type="range" min="0" max="100" value="20" class="slider" id="myRange" />
        </div>
        <script>
            var width = 1100;
            var slider = document.getElementById('myRange');
            d3.select('slider').style('width', width);
            // Update the current slider value (each time you drag the slider handle)
            var height = 650;
            var data;
            var stateCodes = [];
            var counties = [];
            var voronoiCells;
            var countyPolygons;
            var postStationCircles;

            const offset = 5;
            var minLat, maxLat, minLon, maxLon;
            var lonScale, latScale;

            function updateScales() {
                lonScale = d3.scaleLinear().domain([maxLon, minLon]).range([width, 0]);
                latScale = d3.scaleLinear().domain([maxLat, minLat]).range([0, height]);
            }

            var transform = (list) => {
                let result = [];
                result.push(lonScale(list[1]));
                result.push(latScale(list[0]));
                return result;
            };

            function fetchMinMaxLatLonFromData(data) {
                let lats = data.map((e) => +e.lat);
                let lons = data.map((e) => +e.lon);
                minLat = d3.min(lats) - offset;
                minLon = d3.min(lons) - offset;
                maxLat = d3.max(lats) + offset;
                maxLon = d3.max(lons) + offset;
                updateScales();
            }

            function isNotHirstorical(row) {
                return !row['name'].endsWith('(historical)');
            }

            var color = d3.scaleOrdinal().range(d3.schemeTableau10);

            var svg = d3.select('body').append('svg').attr('width', width).attr('height', height);

            d3.csv('Data/postoffices_usa.csv').then(function (csvData) {
                let mainList = [];
                fetchMinMaxLatLonFromData(csvData);
                csvData.forEach((row) => {
                    if (isNotHirstorical(row)) {
                        let lat = +row.lat;
                        let lon = +row.lon;
                        mainList.push(transform([lat, lon]));
                    }
                });
                data = mainList;

                console.log('contains ' + data.length + ' elements');

                var delaunay = d3.Delaunay.from(data);
                var voronoi = delaunay.voronoi([0, 0, width, height]);
                var renderedVoronoi = voronoi.render();

                delaunay.findAll = function (x, y, radius) {
                    const points = delaunay.points,
                        results = [],
                        seen = [],
                        queue = [delaunay.find(x, y)];

                    while (queue.length) {
                        const q = queue.pop();
                        if (seen[q]) continue;
                        seen[q] = true;
                        if (Math.hypot(x - points[2 * q], y - points[2 * q + 1]) < radius) {
                            results.push(q);
                            for (const p of delaunay.neighbors(q)) queue.push(p);
                        }
                    }

                    return results;
                };

                d3.csv('Data/count_usa.csv').then(function (csvData) {
                    csvData.forEach((d) => {
                        let dataSet = JSON.parse(d.json_object);
                        dataSet.county = d.county;
                        let stateCode = d.state_code;
                        dataSet.state_code = stateCode;
                        if (!stateCodes.includes(stateCode)) {
                            stateCodes.push(stateCode);
                        }
                        counties.push(dataSet);
                    });

                    var countySpace = svg.append('g').attr('id', 'county-space');
                    var circleSpace = svg.append('g').attr('id', 'circle-space');
                    var cellSpace = svg.append('g').attr('id', 'cell-space');

                    voronoiCells = cellSpace
                        .selectAll('path')
                        .data(data)
                        .enter()
                        .append('path')
                        .attr('d', (d, i) => voronoi.renderCell(i))
                        .attr('fill', (d, i) => color(i))
                        .style('opacity', '.2')
                        .style('stroke', 'black')
                        .style('stroke-width', '.5');

                    postStationCircles = circleSpace
                        .selectAll('circle')
                        .data(data)
                        .join('circle')
                        .attr('fill', 'green')
                        .attr('cx', (d) => d[0])
                        .attr('cy', (d) => d[1])
                        .attr('r', 1);

                    countyPolygons = countySpace
                        .selectAll('polygon')
                        .data(counties)
                        .enter()
                        .append('polygon')
                        .attr('points', (d) =>
                            d.coordinates[0]
                                .map((d) => [lonScale(d[0]), latScale(d[1])].join(','))
                                .join(' ')
                        )
                        .style('fill', (d) => color(stateCodes.indexOf(d.state_code)))
                        .style('opacity', '.8')
                        .style('stroke', 'black')
                        .style('stroke-opacity', '.2')
                        .style('stroke-width', '1');
                });
                //var results = delaunay.findAll(width / 2, height / 2, 25);
            });

            function colorRedraw(voronoiValue) {
                let counties = 100 - voronoiValue;
                voronoiValue /= 100;
                counties /= 100;
                voronoiCells.style('opacity', voronoiValue);
                countyPolygons.style('opacity', counties);
            }

            slider.oninput = () => colorRedraw(slider.value);
        </script>
    </body>
</html>
