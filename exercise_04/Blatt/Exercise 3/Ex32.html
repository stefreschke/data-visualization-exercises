<html>
    <header>
        <style>
            .line {
                opacity: 0.5;
            }

            svg {
                font: 10px sans-serif;
            }

            * {
                font-family: 'sans serif';
            }

            .label {
                font-size: 12pt;
            }
        </style>
    </header>

    <body>
        <div id="my_dataviz"></div>
        <script src="//d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/d3-delaunay@5"></script>
        <script src="https://unpkg.com/topojson@3"></script>
        <script>
            // set the dimensions and margins of the graph
            var margin = { top: 10, right: 30, bottom: 50, left: 80 },
                width = 1800 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;

            // append the svg object to the body of the page
            var svg = d3
                .select('#my_dataviz')
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

            // d3 = require.alias({ 'd3-array': 'd3@6', 'd3-delaunay': 'd3@6', 'd3-geo': 'd3@6' })(
            //     'd3@6',
            //     'd3-geo-voronoi@1'
            // );
            // topojson = require('topojson-client@3');
            // const svg = d3.create('svg').attr('viewBox', [0, 0, 975, 610]);
            var projection = d3.geoAlbers().scale(1300).translate([487.5, 305]);
            var path = d3.geoPath().projection(projection);
            console.log(path);

            var counties = [];
            d3.csv('Data/count_usa.csv').then((csvData) => {
                csvData.forEach((d) => {
                    let dataSet = JSON.parse(d.json_object);
                    dataSet.county = d.county;
                    dataSet.state_code = d.state_code;
                    counties.push(dataSet);
                });

                newCounties = {
                    type: 'FeatureCollection',
                    features: [],
                };
                console.log('forEach ' + counties.length);
                counties.forEach((c) => {
                    let newFeature = {
                        type: 'Feature',
                        id: c.county,
                        properties: { name: c.county, county: c.county, state: c.state_code },
                        geometry: {
                            type: 'Polygon',
                            coordinates: c.coordinates,
                        },
                    };
                    newCounties.features.push(newFeature);
                });

                console.log(newCounties);
                console.log(counties);
                console.log(path(counties))

                svg.append('path')
                    .attr('d', path(counties))
                    .attr('fill', 'lightgray')
                    .attr('stroke', 'white');
            });

            console.log('Finished loading count_usa.csv');

            var data = [];
            d3.csv('Data/postoffices_usa.csv').then((d) => {
                data.push({
                    type: 'Feature',
                    properties: d,
                    geometry: {
                        type: 'Point',
                        coordinates: [+d.lon, +d.lat],
                    },
                });
            });

            console.log('Finished loading postoffices_usa.csv');

            // svg.append('path')
            //     .datum(
            //         topojson.merge(
            //             counties,
            //             counties.filter((d) => d.state_code !== 'AK' && d.state_code !== 'HI')
            //         )
            //     )
            //     .attr('fill', '#ddd')
            //     .attr('d', d3.geoPath());

            //             svg.append('path')
            //                 .datum(topojson.mesh(counties, counties.coordinates, (a, b) => a !== b))
            //                 .attr('fill', 'none')
            //                 .attr('stroke', 'white')
            //                 .attr('stroke-linejoin', 'round')
            //                 .attr('d', d3.geoPath());

            //             svg.append('g')
            //                 .attr('fill', 'none')
            //                 .attr('stroke', 'red')
            //                 .attr('pointer-events', 'all')
            //                 .selectAll('path')
            //                 .data(d3.geoVoronoi().polygons(data).features)
            //                 .join('path')
            //                 .attr('d', d3.geoPath(projection))
            //                 .append('title')
            //                 .text((d) => {
            //                     const p = d.properties.site.properties;
            //                     return `${p.name} Airport
            // ${p.city}, ${p.state}`;
            //                 });

            //             svg.append('path')
            //                 .datum({ type: 'FeatureCollection', features: data })
            //                 .attr('d', d3.geoPath(projection).pointRadius(1.5));

            // const node = svg.node();
            // console.log(node);
        </script>
    </body>
</html>
